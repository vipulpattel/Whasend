<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add Profile</title>
  <style>
    :root{ --bg:#f7fafc; --card:#ffffff; --muted:#374151; --accent:#2563eb; --radius:8px }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:var(--bg); margin:0;padding:14px;color:#0f172a}
    .container{max-width:520px;margin:8px auto}
    .card{background:var(--card);border-radius:var(--radius);padding:12px;border:1px solid #e6eef6;box-shadow:0 8px 20px rgba(2,6,23,0.06)}
    h2{margin:0 0 8px;font-size:16px}
    label{display:block;font-weight:600;margin-bottom:6px}
    input[type=text]{width:100%;padding:8px 10px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px;transition:border-color 0.2s;}
    input[type=text]:focus{outline:none;border-color:#2563eb}
    input[type=text].valid{border-color:#059669}
    input[type=text].invalid{border-color:#dc2626}
    .validation-hint{font-size:12px;color:#6b7280;margin-top:4px;line-height:1.3}
    .validation-message{font-size:12px;margin-top:4px;line-height:1.3}
    .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    #qrContainer{margin-top:12px;text-align:center}
    #qrContainer img{max-width:100%;height:auto;border-radius:8px;border:1px solid #e6eef6}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Add New Profile</h2>
      <div id="form">
        <label for="profileName">Profile Name</label>
        <input id="profileName" type="text" placeholder="Enter profile name" maxlength="50" />
        <div class="validation-hint">
          ✅ Only letters, numbers, underscore (_), and hyphen (-)<br>
          ✅ 2-50 characters, cannot start with number<br>
          ❌ No spaces or special characters
        </div>
        <div id="validationMessage" class="validation-message" style="display:none;"></div>
        <div class="actions">
            <button id="saveBtn" class="btn" onclick="saveProfile()">Save</button>
        </div>
      </div>
      <div id="qrContainer"></div>
    </div>
  </div>

    <!-- Loader overlay -->
    <div id="profileLoader" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9999; justify-content:center; align-items:center;">
      <div style="background:#fff;padding:18px 22px;border-radius:10px;display:flex;flex-direction:column;align-items:center;gap:10px;box-shadow:0 8px 24px rgba(2,6,23,0.12)">
        <div style="width:44px;height:44px;border-radius:50%;border:6px solid #f1f5f9;border-top-color:#2563eb;animation:spin 1s linear infinite"></div>
        <div id="profileLoaderText" style="font-weight:700;color:#2563eb">Preparing profile...</div>
      </div>
    </div>

    <style>@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}</style>

  <script>
    const { ipcRenderer } = require("electron");

    // Profile name validation function
    function validateProfileName(name) {
      const errors = [];
      
      // Check if empty
      if (!name || name.trim() === '') {
        errors.push('Profile name cannot be empty');
      }
      
      // Check length (minimum 2, maximum 50 characters)
      if (name.length < 2) {
        errors.push('Profile name must be at least 2 characters long');
      }
      
      if (name.length > 50) {
        errors.push('Profile name cannot exceed 50 characters');
      }
      
      // Check for spaces
      if (/\s/.test(name)) {
        errors.push('Profile name cannot contain spaces');
      }
      
      // Check for invalid characters (only allow letters, numbers, underscore, hyphen)
      if (!/^[a-zA-Z0-9_-]+$/.test(name)) {
        errors.push('Profile name can only contain letters, numbers, underscore (_), and hyphen (-)');
      }
      
      // Check if starts with number
      if (/^[0-9]/.test(name)) {
        errors.push('Profile name cannot start with a number');
      }
      
      // Check for reserved names
      const reservedNames = ['all', 'none', 'null', 'undefined', 'admin', 'system', 'default'];
      if (reservedNames.includes(name.toLowerCase())) {
        errors.push('Profile name cannot be a reserved word');
      }
      
      return errors;
    }

    // Real-time validation
    document.addEventListener('DOMContentLoaded', function() {
      const nameInput = document.getElementById('profileName');
      const validationMsg = document.getElementById('validationMessage');
      const saveBtn = document.getElementById('saveBtn');
      
      nameInput.addEventListener('input', function() {
        const value = this.value;
        const errors = validateProfileName(value);
        
        if (value && errors.length > 0) {
          validationMsg.innerHTML = `❌ ${errors[0]}`;
          validationMsg.style.color = '#dc2626';
          validationMsg.style.display = 'block';
          this.className = 'invalid';
          saveBtn.disabled = true;
        } else if (value && errors.length === 0) {
          validationMsg.innerHTML = `✅ Valid profile name`;
          validationMsg.style.color = '#059669';
          validationMsg.style.display = 'block';
          this.className = 'valid';
          saveBtn.disabled = false;
        } else {
          validationMsg.style.display = 'none';
          this.className = '';
          saveBtn.disabled = !value;
        }
      });
    });

    function saveProfile() {
      const name = document.getElementById("profileName").value.trim();
      
      // Validate profile name before saving
      const validationErrors = validateProfileName(name);
      if (validationErrors.length > 0) {
        alert('❌ Invalid Profile Name:\n\n' + validationErrors.join('\n'));
        return;
      }

      if (name) {
        // show loader until QR appears (or profile added)
        try { document.getElementById('profileLoaderText').textContent = 'Preparing profile...'; } catch (e) {}
        const loader = document.getElementById('profileLoader'); if (loader) loader.style.display = 'flex';
        const saveBtn = document.getElementById('saveBtn'); if (saveBtn) saveBtn.disabled = true;
        ipcRenderer.send("start-profile", name);
      }
    }

    ipcRenderer.on("show-qr", (event, { profileName, qrImage }) => {
      // hide loader and show QR
      try { document.getElementById('profileLoader').style.display = 'none'; } catch (e) {}
      try { document.getElementById('saveBtn').disabled = false; } catch (e) {}
      document.getElementById("form").style.display = "none";
      document.getElementById("qrContainer").innerHTML = `
        <h3>Scan this QR for ${profileName}</h3>
        <img src="${qrImage}" />
        <p>Open WhatsApp → Linked Devices → Scan this QR → Wait for the response</p>
      `;
    });

    ipcRenderer.on("profile-added", (event, profileName) => {
      try { document.getElementById('profileLoader').style.display = 'none'; } catch (e) {}
      try { document.getElementById('saveBtn').disabled = false; } catch (e) {}
      alert(`✅ Profile "${profileName}" added successfully!`);
      
      // Auto-close window after successful profile addition
      setTimeout(() => {
        window.close();
      }, 500); // Small delay to ensure alert is shown
    });

    ipcRenderer.on('start-profile-failed', (event, { message }) => {
      try { document.getElementById('profileLoader').style.display = 'none'; } catch (e) {}
      try { document.getElementById('saveBtn').disabled = false; } catch (e) {}
      alert('Could not add profile: ' + (message || 'Unknown reason'));
    });
  </script>
</body>
</html>
