<!DOCTYPE html>
<html>
<head>
  <title>Whasend Templates</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f7fafc;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .template-card {
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .template-info {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .template-details {
      flex: 1;
    }
    
    .template-name {
      font-weight: 600;
      font-size: 14px;
      color: #1e293b;
      margin-bottom: 2px;
    }
    
    .template-type {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: 500;
      margin-right: 8px;
    }
    
    .type-text {
      background: #dbeafe;
      color: #1d4ed8;
    }
    
    .type-media {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .template-message {
      color: #64748b;
      font-size: 13px;
      line-height: 1.3;
      max-width: 400px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .media-preview-small {
      width: 40px;
      height: 40px;
      border-radius: 4px;
      object-fit: cover;
      border: 1px solid #d1d5db;
    }
    
    .media-icon-small {
      width: 40px;
      height: 40px;
      background: #f3f4f6;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #6b7280;
      border: 1px solid #e5e7eb;
    }
    
    .buttons {
      display: flex;
      gap: 6px;
    }
    
    button {
      padding: 6px 12px;
      cursor: pointer;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #f9fafb;
    }
    
    .btn-edit {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .btn-edit:hover {
      background: #2563eb;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .preview-btn {
      background: #0891b2;
      color: white;
      border-color: #0891b2;
      padding: 4px 8px;
      font-size: 11px;
    }
    
    .preview-btn:hover {
      background: #0e7490;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    /* Modal for media preview */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
      position: relative;
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close:hover {
      color: black;
    }
    
    .modal img, .modal video {
      max-width: 100%;
      max-height: 400px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0;">Templates Management</h2>
    <div>
      <button class="btn-primary" onclick="openAddTemplate()">‚ûï Add New Template</button>
      <button onclick="loadTemplates()">üîÑ Refresh</button>
    </div>
  </div>

  <div id="templateList"></div>
  
  <!-- Media Preview Modal -->
  <div id="mediaModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3 id="modalTitle">Media Preview</h3>
      <div id="modalContent"></div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require("electron");
    const path = require("path");

    // Listen for BroadcastChannel notifications from other windows (HTML-only refresh)
    try {
      const templatesChannel = new BroadcastChannel('whatsapp-multi-templates');
      templatesChannel.onmessage = (ev) => {
        try {
          const msg = ev.data;
          if (msg && msg.type === 'template-saved') {
            // reload templates when a new template is saved/updated
            loadTemplates();
          }
        } catch (e) { console.error('templatesChannel handler error', e); }
      };
    } catch (e) {}

    async function loadTemplates() {
      let templates = [];

      try {
        templates = await ipcRenderer.invoke('get-templates');
      } catch (err) {
        console.error('Failed to fetch templates from main process:', err);
        templates = [];
      }

      displayTemplates(templates);
    }

    function displayTemplates(templates) {
      const templateList = document.getElementById('templateList');
      
      if (!templates || templates.length === 0) {
        templateList.innerHTML = `
          <div class="empty-state">
            <h3>No Templates Found</h3>
            <p>Create your first template to get started!</p>
          </div>
        `;
        return;
      }

      templateList.innerHTML = '';

      templates.filter(t => !t.is_delete).forEach(template => {
        const isMediaTemplate = template.type === 'Media';
        
        const card = document.createElement('div');
        card.className = 'template-card';
        
        card.innerHTML = `
          <div class="template-info">
            ${isMediaTemplate && template.media_filename ? `
              ${getMediaPreviewSmall(template)}
            ` : ''}
            
            <div class="template-details">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 2px;">
                <span class="template-name">${template.name}</span>
                <span class="template-type ${template.type === 'Media' ? 'type-media' : 'type-text'}">
                  ${template.type === 'Media' ? 'üé¨ Media' : 'üìù Text'}
                </span>
                ${isMediaTemplate && template.media_filename ? `
                  <button class="preview-btn" data-media-path="${template.media_path.replace(/\\/g, '\\\\')}" data-media-filename="${template.media_filename}">
                    üëÅÔ∏è Preview
                  </button>
                ` : ''}
              </div>
              <div class="template-message">${template.message}</div>
            </div>
          </div>
          
          <div class="buttons">
            <button class="btn-edit" onclick="editTemplate('${template.name}')">‚úèÔ∏è Edit</button>
            <button class="btn-danger" onclick="deleteTemplate('${template.name}')">üóëÔ∏è Delete</button>
          </div>
        `;
        
        templateList.appendChild(card);
      });
      
      // Add event listeners for preview buttons
      document.querySelectorAll('.preview-btn').forEach(button => {
        button.addEventListener('click', function() {
          const mediaPath = this.getAttribute('data-media-path');
          const mediaFilename = this.getAttribute('data-media-filename');
          previewMedia(mediaPath, mediaFilename);
        });
      });
    }

    function getMediaPreviewSmall(template) {
      if (!template.media_filename) return '';
      
      const extension = template.media_filename.split('.').pop().toLowerCase();
      const mediaPath = template.media_path;
      
      if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
        return `<img src="${mediaPath}" alt="Preview" class="media-preview-small" onerror="this.style.display='none';">`;
      } else if (['mp4', 'avi', 'mov', 'wmv'].includes(extension)) {
        return `<div class="media-icon-small">üé¨</div>`;
      } else if (['mp3', 'wav', 'ogg', 'm4a'].includes(extension)) {
        return `<div class="media-icon-small">üéµ</div>`;
      } else if (['pdf'].includes(extension)) {
        return `<div class="media-icon-small">üìÑ</div>`;
      } else {
        return `<div class="media-icon-small">üìé</div>`;
      }
    }

    function getMediaType(filename) {
      if (!filename) return 'Unknown';
      
      const extension = filename.split('.').pop().toLowerCase();
      
      if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension)) {
        return 'Image';
      } else if (['mp4', 'avi', 'mov', 'wmv'].includes(extension)) {
        return 'Video';
      } else if (['mp3', 'wav', 'ogg', 'm4a'].includes(extension)) {
        return 'Audio';
      } else if (['pdf'].includes(extension)) {
        return 'Document';
      } else {
        return 'File';
      }
    }

    async function previewMedia(mediaPath, filename) {
      console.log('Preview Media - Path:', mediaPath, 'Filename:', filename);
      
      const modal = document.getElementById('mediaModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');
      
      modalTitle.textContent = `Preview: ${filename}`;
      modalContent.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
      modal.style.display = 'block';
      
      try {
        // Use IPC to get media preview data
        const result = await ipcRenderer.invoke('get-media-preview', mediaPath);
        
        if (!result.success) {
          modalContent.innerHTML = `
            <div style="text-align: center; padding: 20px; color: red;">
              <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
              <p>Failed to load media file</p>
              <p><strong>${filename}</strong></p>
              <p>Error: ${result.error}</p>
            </div>
          `;
          return;
        }
        
        const { mediaType, previewData } = result;
        
        if (mediaType === 'image' && previewData) {
          modalContent.innerHTML = `<img src="${previewData}" alt="${filename}" style="max-width: 100%; max-height: 400px; display: block; margin: 0 auto;">`;
        } else if (mediaType === 'video') {
          // Convert Windows path to file:// protocol for video
          let videoPath = mediaPath;
          if (videoPath && !videoPath.startsWith('file://') && !videoPath.startsWith('http')) {
            videoPath = 'file:///' + videoPath.replace(/\\/g, '/');
          }
          modalContent.innerHTML = `
            <video controls style="max-width: 100%; max-height: 400px; display: block; margin: 0 auto;">
              <source src="${videoPath}" type="video/${filename.split('.').pop().toLowerCase()}">
              Your browser does not support the video tag.
            </video>
          `;
        } else if (mediaType === 'audio') {
          // Convert Windows path to file:// protocol for audio
          let audioPath = mediaPath;
          if (audioPath && !audioPath.startsWith('file://') && !audioPath.startsWith('http')) {
            audioPath = 'file:///' + audioPath.replace(/\\/g, '/');
          }
          modalContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 10px;">üéµ</div>
              <audio controls style="width: 100%; max-width: 400px;">
                <source src="${audioPath}" type="audio/${filename.split('.').pop().toLowerCase()}">
                Your browser does not support the audio tag.
              </audio>
              <p><strong>${filename}</strong></p>
            </div>
          `;
        } else {
          modalContent.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 48px; margin-bottom: 10px;">üìé</div>
              <p>Preview not available for this file type</p>
              <p><strong>${filename}</strong></p>
              <p>Type: ${mediaType}</p>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Error loading media preview:', error);
        modalContent.innerHTML = `
          <div style="text-align: center; padding: 20px; color: red;">
            <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
            <p>Error loading media preview</p>
            <p><strong>${filename}</strong></p>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    function closeModal() {
      document.getElementById('mediaModal').style.display = 'none';
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('mediaModal');
      if (event.target === modal) {
        modal.style.display = 'none';
      }
    };

    function openAddTemplate() {
      ipcRenderer.send("open-add-template");
    }

    function editTemplate(templateName) {
      ipcRenderer.send("open-edit-template", templateName);
    }

    function deleteTemplate(templateName) {
      if (confirm(`Are you sure you want to delete template "${templateName}"?`)) {
        ipcRenderer.send("delete-template", templateName);
      }
    }

    ipcRenderer.on("delete-template-success", (event, name) => {
      alert(`‚úÖ Template "${name}" deleted successfully.`);
      loadTemplates();
    });

    ipcRenderer.on("delete-template-failed", (event, name) => {
      alert(`‚ùå Failed to delete Template "${name}". It may not exist.`);
      loadTemplates();
    });

    ipcRenderer.on("refresh-templates", () => {
      loadTemplates();
    });

    // Load templates when page loads
    loadTemplates();
    
    // Debug function to check media files
    window.debugMediaFiles = async function() {
      try {
        const result = await ipcRenderer.invoke('debug-media-files');
        console.log('Debug Media Files Result:', result);
        
        if (result.success) {
          console.log('Media Folder:', result.mediaPath);
          console.log('Files Found:', result.files);
          console.log('Media Templates in DB:', result.mediaTemplates);
          
          // Check for mismatches
          if (result.mediaTemplates && result.mediaTemplates.length > 0) {
            result.mediaTemplates.forEach(template => {
              const expectedFile = template.media_filename;
              const fileExists = result.files.includes(expectedFile);
              console.log(`Template "${template.name}": File "${expectedFile}" exists: ${fileExists}`);
              if (!fileExists) {
                console.warn(`Missing file for template "${template.name}": ${template.media_path}`);
              }
            });
          }
        } else {
          console.error('Debug failed:', result.error);
        }
        
        return result;
      } catch (error) {
        console.error('Debug error:', error);
      }
    };
  </script>
</body>
</html>
