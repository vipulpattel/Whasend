<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Login</title>
  <style>
    body { font-family: Arial, sans-serif; display:flex; height:100vh; justify-content:center; align-items:center; background:#f4f4f4; }
  .login-box { background: linear-gradient(180deg,#ffffff 0%, #fbfdff 100%); padding:28px; border-radius:12px; box-shadow:0 10px 30px rgba(8,15,30,0.12); width:360px; max-width:92vw; border:1px solid #e6eef9; }
  .login-box .logo { text-align:center; margin-bottom:12px; }
  .login-box .logo h2{ margin:0; font-size:20px; letter-spacing:0.4px }
  .login-box h2 { text-align:center; margin-bottom:12px; font-size:18px }
  .login-box .field { margin:12px 0; }
  .login-box input { width:100%; padding:12px 14px; margin:6px 0; border:1px solid #e2e8f0; border-radius:8px; font-size:14px; box-sizing:border-box }
  .login-box input:focus { outline:none; box-shadow:0 0 0 4px rgba(11,116,222,0.07); border-color:#0b74de }
  .login-box button { width:100%; padding:12px; background:#0b74de; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px }
  .login-box button:hover { background:#075fb5; }
  #message { margin-top:12px; text-align:center; font-size:13px; color:#d0342c; min-height:18px }
  /* auxiliary links removed (remember/forgot) */
    .dialog-bg {
      display: none;
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .dialog {
      background: #fff; padding: 18px; border-radius: 10px; width: 380px; box-shadow: 0 6px 24px rgba(8,15,30,0.2);
      font-family: Arial, sans-serif;
    }
    .dialog .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px }
    .dialog .title { font-weight:700; font-size:16px }
    .dialog .close { background:transparent;border:none;font-size:18px;cursor:pointer }
    .dialog p.msg { margin:8px 0 12px 0; color:#444 }
    .dialog .emailField { display:flex; gap:8px; align-items:center; margin-bottom:12px }
    .dialog .emailField input { flex:1; padding:10px;border:1px solid #ddd;border-radius:6px }
    .dialog .actions { display:flex; gap:8px; justify-content:flex-end }
    .dialog .btn { padding:8px 12px;border-radius:6px;border:none;cursor:pointer }
    .dialog .btn.primary { background:#007bff;color:#fff }
    .dialog .btn.secondary { background:#f3f4f6;color:#111;border:1px solid #e5e7eb }
    .dialog input { width: 100%; padding: 8px; margin: 6px 0; }
    .dialog button { margin-right: 10px; }
  </style>
</head>
<body>
  <div class="login-box">
    <div class="logo"><h2>Whasend — Login</h2></div>
    <div class="field">
      <label for="username" class="sr-only">Username</label>
      <input type="text" id="username" placeholder="Username or email" aria-label="Username" />
    </div>
    <div class="field">
      <label for="password" class="sr-only">Password</label>
      <input type="password" id="password" placeholder="Password" aria-label="Password" />
    </div>
    <div class="field">
      <button id="loginBtn">Sign in</button>
    </div>
    <!-- auxiliary links removed -->
    <div id="message"></div>
  </div>

  <!-- Loader overlay -->
  <div id="loaderOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:9999; justify-content:center; align-items:center;">
    <div style="background:rgba(255,255,255,0.95); padding:20px 26px; border-radius:10px; display:flex; flex-direction:column; align-items:center; gap:10px;">
      <div class="spinner" style="width:48px; height:48px; border-radius:50%; border:5px solid #e6eef9; border-top-color:#0b74de; animation:spin 1s linear infinite"></div>
      <div id="loaderText" style="font-weight:600; color:#0b74de">Signing in...</div>
    </div>
  </div>

  <style>
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  </style>

  <!-- Add Activation Dialog -->
  <div class="dialog-bg" id="dialogd">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="activateTitle">
      <div class="header">
        <div class="title" id="activateTitle">Activation Required</div>
        <button class="close" aria-label="Close" onclick="closeDialog()">✕</button>
      </div>
      <p class="msg" id="ActivateMsg">Your profile needs activation to continue.</p>
      <div class="emailField">
        <input type="email" id="email" placeholder="Email for activation" readonly value="">
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="closeDialog()">Cancel</button>
        <button class="btn primary" id="activateBtn" onclick="Activate()">Activate Now</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require("electron");

    const loginBtn = document.getElementById("loginBtn");
    function showLoader(text) {
      try { document.getElementById('loaderText').textContent = text || 'Signing in...'; } catch (e) {}
      const o = document.getElementById('loaderOverlay'); if (o) o.style.display = 'flex';
      if (loginBtn) loginBtn.disabled = true;
    }
    function hideLoader() {
      const o = document.getElementById('loaderOverlay'); if (o) o.style.display = 'none';
      if (loginBtn) loginBtn.disabled = false;
    }

    document.getElementById("loginBtn").addEventListener("click", () => {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      // show loader until we receive a reply
      showLoader('Signing in...');
      ipcRenderer.send("login-request", { username, password });
    });

    // allow Enter key to submit form
    ['username','password'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('keydown', function(e){ if (e.key === 'Enter') document.getElementById('loginBtn').click(); });
    });

    ipcRenderer.on("login-reactivate", (event, res) => {
    hideLoader();
    document.getElementById("message").textContent = "⏳ " + res.message;
        document.getElementById("ActivateMsg").textContent = "❌ " + res.message;
        document.getElementById("email").value = res.email;
        document.getElementById("dialogd").style.display = "flex";
        //alert("Your profile has expired. Please renew.");
    });

    ipcRenderer.on("login-notactivated", (event, res) => {
    hideLoader();
    document.getElementById("message").textContent = "❌ " + res.message;
        document.getElementById("ActivateMsg").textContent = "❌ " + res.message;
        document.getElementById("email").value = res.email;
        document.getElementById("dialogd").style.display = "flex";

    });

    ipcRenderer.on("login-failed", (event, res) => {
    hideLoader();
    document.getElementById("message").textContent = "❌ " + res.message;
    });
    //ipcRenderer.on("Activate-success", (event, res) => {
    //    alert("This System Registered. Please login now.");
    //});
    //ipcRenderer.on("Activate-error", (event, res) => {
    //    alert("Something went wrong. Please Retry now or sometimes later.");
    //});

    async function Activate() {
      const patient = {
        email: document.getElementById("email").value
      };
      const result = await ipcRenderer.invoke("Activate-here", patient);
      if (result.error) {
        alert("Activation failed, Please Retry");
        } else {
        alert("Activation Success,Please Login Now");
        }
      closeDialog();
    }

    function closeDialog() {
    document.getElementById("dialogd").style.display = "none";
    }

    // close when clicking outside the dialog content
    document.getElementById('dialogd').addEventListener('click', function(e){
      if (e.target && e.target.id === 'dialogd') closeDialog();
    });

    // close on ESC
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape') closeDialog(); });


  </script>
</body>
</html>
