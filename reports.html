<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Reports ‚Äî Whasend</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root{--bg:#f6f8fa;--card:#ffffff;--muted:#6b7280;--accent:#0b74de}
      body{font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);margin:0;padding:18px;color:#111}
      .container{display:flex;gap:16px}
      .left{flex:1}
      .right{width:360px}
      .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
      input.search{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
      button.action{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
      .card{background:var(--card);padding:12px;border-radius:10px;border:1px solid #e6edf3;box-shadow:0 1px 2px rgba(16,24,40,0.03);margin-bottom:12px}
      .report-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
      .meta{font-size:13px;color:var(--muted)}
      .title{font-weight:600}
      .progress{height:10px;background:#eef2f7;border-radius:8px;overflow:hidden}
      .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#4aa0f3);}
      .small{font-size:12px;color:var(--muted)}
      .controls{display:flex;gap:6px}
      .controls button{padding:6px 8px;border-radius:6px;border:1px solid #e0e7ef;background:#fff;cursor:pointer}
      .pagination{display:flex;align-items:center;justify-content:space-between;margin:16px 0;padding:12px;background:var(--card);border-radius:8px;border:1px solid #e6edf3}
      .pagination-info{font-size:14px;color:var(--muted)}
      .pagination-controls{display:flex;gap:8px;align-items:center}
      .pagination button{padding:6px 12px;border-radius:6px;border:1px solid #e0e7ef;background:#fff;cursor:pointer;font-size:13px}
      .pagination button:disabled{opacity:0.5;cursor:not-allowed}
      .pagination button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
      .pagination select{padding:4px 8px;border-radius:4px;border:1px solid #ddd;font-size:13px}
      .right h3{margin-top:0}
      .alerts{max-height:260px;overflow:auto}
      .alert-item{padding:8px;border-radius:6px;border:1px solid #fdecea;background:#fff6f6;margin-bottom:8px}
      label{display:block;font-size:13px;margin-top:8px}
      .settings input{width:95%;padding:8px;border-radius:6px;border:1px solid #ddd}
    </style>
  </head>
  <body>
    <div class="toolbar">
      <input class="search" id="search" placeholder="Search reports..." />
      <button class="action" id="refreshBtn">üîÑ Refresh</button>
      <button class="action" id="clearAllLogsBtn" style="background: #dc3545;">üóëÔ∏è Clear All Logs</button>
      <div id="autoRefreshIndicator" style="display: none; color: #4CAF50; font-size: 12px; margin-left: 10px;">
        üîÑ Auto-refreshing every 5s
      </div>
      <!-- Safe Mode button hidden - always enabled in background -->
      <button class="action" id="safeModeBtn" style="display: none;">üõ°Ô∏è Safe Mode</button>
    </div>

    <div class="container">
      <div class="left">
        <div class="card" id="statsCard">
          <h3>Daily Summary (last 7 days)</h3>
          <div id="dailyStats">Loading...</div>
        </div>
        
        <!-- Pagination Controls -->
        <div class="pagination" id="paginationTop">
          <div class="pagination-info" id="paginationInfo">Loading...</div>
          <div class="pagination-controls">
            <select id="itemsPerPage">
              <option value="10">10 per page</option>
              <option value="25" selected>25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
            <button id="prevBtn">‚Üê Previous</button>
            <span id="pageNumbers"></span>
            <button id="nextBtn">Next ‚Üí</button>
          </div>
        </div>
        
        <div id="reportsContainer"></div>
        
        <!-- Bottom Pagination -->
        <div class="pagination" id="paginationBottom" style="margin-top:16px">
          <div class="pagination-info" id="paginationInfoBottom">Loading...</div>
          <div class="pagination-controls">
            <button id="prevBtnBottom">‚Üê Previous</button>
            <span id="pageNumbersBottom"></span>
            <button id="nextBtnBottom">Next ‚Üí</button>
          </div>
        </div>
      </div>

      <div class="right">
        <div class="card">
          <h3>Alerts</h3>
          <div class="alerts" id="alertsList">Loading...</div>
          <div style="text-align:right;margin-top:8px"><button id="clearAlerts">Clear Alerts</button></div>
        </div>

        <div class="card" id="settingsCard" style="display:none">
          <h3>Settings</h3>
          <div class="settings">
            <label>Global rate (messages / minute)</label>
            <input id="rateLimitPerMinute" type="number" />
            <label>Per-profile rate (messages / minute)</label>
            <input id="perProfileLimitPerMinute" type="number" />
            <label>Max consecutive failures before pause</label>
            <input id="maxConsecutiveFailuresBeforePause" type="number" />
            <label>Min wait period between messages (days)</label>
            <input id="minWaitPeriodDays" type="number" min="1" placeholder="e.g., 7" />
            <label>Max messages per profile per day</label>
            <input id="maxPerProfilePerDay" type="number" min="1" placeholder="e.g., 50" />
            <!-- Dry run checkbox hidden - always disabled in background -->
            <label style="display: none;">Dry run (no sends)</label>
            <input id="dryRun" type="checkbox" style="display: none;" />
            <div style="margin-top:8px;text-align:right"><button id="saveSettings">Save</button></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resend Modal -->
    <div id="resendModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999">
      <div style="background:#fff;border-radius:8px;padding:16px;max-width:900px;width:90%;max-height:80%;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.2)">
        <h3>Resend Failed Messages <span id="resendJobId" style="font-weight:400;font-size:13px;color:#666"></span></h3>
        <div id="resendList" style="max-height:400px;overflow:auto;margin-top:8px"></div>
        <div style="margin-top:8px;text-align:right">
          <button id="resendCancelBtn">Cancel</button>
          <button id="resendSendBtn" style="background:#0b74de;color:#fff;border:none;padding:8px 12px;border-radius:6px;">Send Selected</button>
        </div>
        <div id="resendProgress" style="margin-top:8px;font-size:13px;color:#333;display:none"></div>
      </div>
    </div>

    <!-- View Report Modal -->
    <div id="viewReportModal" style="display:none;position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;z-index:9999">
      <div style="background:#fff;border-radius:8px;padding:16px;max-width:1000px;width:95%;max-height:85%;overflow:auto;box-shadow:0 8px 24px rgba(0,0,0,0.2)">
        <h3>Report Records <span id="viewReportJobId" style="font-weight:400;font-size:13px;color:#666"></span></h3>
        <div style="margin-top:8px;margin-bottom:8px;display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div>
            <label class="small">Filter:</label>
            <input id="viewReportFilter" placeholder="Filter by name/phone/status/template" style="padding:6px;border:1px solid #ddd;border-radius:6px;width:360px" />
          </div>
          <div style="text-align:right">
            <button id="exportReportBtn" style="background:#0b74de;color:#fff;border:none;padding:8px 12px;border-radius:6px;">Export to Excel</button>
            <button id="closeViewReportBtn" style="margin-left:8px">Close</button>
          </div>
        </div>
        <div id="viewReportList" style="max-height:520px;overflow:auto;border-top:1px solid #eee;padding-top:8px"></div>
      </div>
    </div>

    <script>
      const { ipcRenderer, shell } = require('electron');
      const reportsContainer = document.getElementById('reportsContainer');
      const alertsList = document.getElementById('alertsList');
      const refreshBtn = document.getElementById('refreshBtn');
      const searchInput = document.getElementById('search');
      const safeModeBtn = document.getElementById('safeModeBtn');
      const clearAllLogsBtn = document.getElementById('clearAllLogsBtn');

      // Pagination variables
      let currentPage = 1;
      let itemsPerPage = 25;
      let allReports = [];
      let filteredReports = [];

      // Pagination elements
      const itemsPerPageSelect = document.getElementById('itemsPerPage');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const prevBtnBottom = document.getElementById('prevBtnBottom');
      const nextBtnBottom = document.getElementById('nextBtnBottom');
      const pageNumbers = document.getElementById('pageNumbers');
      const pageNumbersBottom = document.getElementById('pageNumbersBottom');
      const paginationInfo = document.getElementById('paginationInfo');
      const paginationInfoBottom = document.getElementById('paginationInfoBottom');

      async function loadSettingsToUI() {
        const s = await ipcRenderer.invoke('get-settings');
        document.getElementById('rateLimitPerMinute').value = s.rateLimitPerMinute || 10;
        document.getElementById('perProfileLimitPerMinute').value = s.perProfileLimitPerMinute || 5;
        document.getElementById('maxConsecutiveFailuresBeforePause').value = s.maxConsecutiveFailuresBeforePause || 3;
        document.getElementById('minWaitPeriodDays').value = s.minWaitPeriodDays || 7;
        document.getElementById('maxPerProfilePerDay').value = s.defaultMessageLimitPerProfile || s.maxPerProfilePerDay || 50;
        // Force dry run to always be false (hidden from UI)
        document.getElementById('dryRun').checked = false;
        // Force safe mode to always be ON (hidden from UI)
        safeModeBtn.textContent = 'üõ°Ô∏è Safe Mode: ON';
      }

      document.getElementById('saveSettings').addEventListener('click', async () => {
        const maxPerProfileValue = Number(document.getElementById('maxPerProfilePerDay').value) || 50;
        const settings = {
          rateLimitPerMinute: Number(document.getElementById('rateLimitPerMinute').value) || 10,
          perProfileLimitPerMinute: Number(document.getElementById('perProfileLimitPerMinute').value) || 5,
          maxConsecutiveFailuresBeforePause: Number(document.getElementById('maxConsecutiveFailuresBeforePause').value) || 3,
          minWaitPeriodDays: Number(document.getElementById('minWaitPeriodDays').value) || 7,
          maxPerProfilePerDay: maxPerProfileValue,
          defaultMessageLimitPerProfile: maxPerProfileValue, // Save to defaultMessageLimitPerProfile key
          // Force dry run to always be false (hidden from UI)
          dryRun: false,
          // Force safe mode to always be true (hidden from UI)
          safeMode: true
        };
        const res = await ipcRenderer.invoke('save-settings', settings);
        if (res && res.success) alert('Settings saved');
      });

      // Safe mode toggle disabled - always remains ON
      safeModeBtn.addEventListener('click', async () => {
        // Do nothing - safe mode is always enabled
        console.log('Safe mode is permanently enabled for security');
      });

      document.getElementById('clearAlerts').addEventListener('click', async () => {
        if (confirm('Clear all alerts? This will permanently remove all stored alerts from the database.')) {
          try {
            const result = await ipcRenderer.invoke('clear-alerts');
            if (result && result.success) {
              alertsList.innerHTML = '<div class="small">No alerts</div>';
              alert(`‚úÖ Successfully cleared ${result.cleared || 0} alerts from database.`);
            } else {
              alert(`‚ùå Failed to clear alerts: ${result.error || 'Unknown error'}`);
            }
          } catch (e) {
            console.error('Error clearing alerts:', e);
            alert(`‚ùå Error clearing alerts: ${e.message}`);
          }
        }
      });

      refreshBtn.addEventListener('click', () => loadAll());
      searchInput.addEventListener('input', debounce(() => {
        currentPage = 1; // Reset to first page when searching
        loadAll();
      }, 300));

      // Clear All Logs functionality
      clearAllLogsBtn.addEventListener('click', async () => {
        const confirmMessage = 'Are you sure you want to clear ALL logs and reports?\n\nThis will permanently delete:\n‚Ä¢ All campaign reports\n‚Ä¢ All message sending logs\n‚Ä¢ All job history\n\nThis action cannot be undone!';
        
        if (confirm(confirmMessage)) {
          try {
            clearAllLogsBtn.disabled = true;
            clearAllLogsBtn.textContent = 'üîÑ Clearing...';
            
            const result = await ipcRenderer.invoke('clear-all-logs');
            
            if (result && result.success) {
              alert(`‚úÖ Successfully cleared all logs!\n\nCleared:\n‚Ä¢ ${result.reports || 0} reports\n‚Ä¢ ${result.logs || 0} message logs\n‚Ä¢ ${result.files || 0} report files`);
              
              // Refresh the UI to show empty state
              allReports = [];
              filteredReports = [];
              renderReports();
              await loadDailyStats(); // Refresh stats
            } else {
              alert(`‚ùå Failed to clear logs: ${result?.error || 'Unknown error'}`);
            }
          } catch (e) {
            console.error('Error clearing all logs:', e);
            alert(`‚ùå Error clearing logs: ${e.message}`);
          } finally {
            clearAllLogsBtn.disabled = false;
            clearAllLogsBtn.textContent = 'üóëÔ∏è Clear All Logs';
          }
        }
      });

      // Pagination event listeners
      itemsPerPageSelect.addEventListener('change', () => {
        itemsPerPage = parseInt(itemsPerPageSelect.value);
        currentPage = 1;
        loadAll();
      });

      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderReports();
        }
      });

      nextBtn.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderReports();
        }
      });

      prevBtnBottom.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderReports();
        }
      });

      nextBtnBottom.addEventListener('click', () => {
        const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
        if (currentPage < totalPages) {
          currentPage++;
          renderReports();
        }
      });

      function debounce(fn, wait){let t;return (...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}

      function updatePaginationControls() {
        const totalPages = Math.ceil(filteredReports.length / itemsPerPage);
        const startItem = (currentPage - 1) * itemsPerPage + 1;
        const endItem = Math.min(currentPage * itemsPerPage, filteredReports.length);
        
        // Update info text
        const infoText = filteredReports.length === 0 ? 
          'No reports found' : 
          `Showing ${startItem}-${endItem} of ${filteredReports.length} reports`;
        paginationInfo.textContent = infoText;
        paginationInfoBottom.textContent = infoText;
        
        // Update button states
        const canGoPrev = currentPage > 1;
        const canGoNext = currentPage < totalPages;
        
        prevBtn.disabled = !canGoPrev;
        nextBtn.disabled = !canGoNext;
        prevBtnBottom.disabled = !canGoPrev;
        nextBtnBottom.disabled = !canGoNext;
        
        // Generate page numbers
        updatePageNumbers(totalPages);
      }

      function updatePageNumbers(totalPages) {
        function generatePageButtons(container) {
          container.innerHTML = '';
          
          if (totalPages <= 1) return;
          
          const maxVisiblePages = 5;
          let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
          let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
          
          if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
          }
          
          // First page
          if (startPage > 1) {
            const btn = document.createElement('button');
            btn.textContent = '1';
            btn.onclick = () => { currentPage = 1; renderReports(); };
            container.appendChild(btn);
            
            if (startPage > 2) {
              const ellipsis = document.createElement('span');
              ellipsis.textContent = '...';
              ellipsis.style.padding = '6px';
              container.appendChild(ellipsis);
            }
          }
          
          // Page range
          for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            btn.className = i === currentPage ? 'active' : '';
            btn.onclick = () => { currentPage = i; renderReports(); };
            container.appendChild(btn);
          }
          
          // Last page
          if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
              const ellipsis = document.createElement('span');
              ellipsis.textContent = '...';
              ellipsis.style.padding = '6px';
              container.appendChild(ellipsis);
            }
            
            const btn = document.createElement('button');
            btn.textContent = totalPages;
            btn.onclick = () => { currentPage = totalPages; renderReports(); };
            container.appendChild(btn);
          }
        }
        
        generatePageButtons(pageNumbers);
        generatePageButtons(pageNumbersBottom);
      }

      async function loadAlerts() {
        try {
          const al = await ipcRenderer.invoke('get-alerts');
          alertsList.innerHTML = '';
          if (!al || al.length === 0) { alertsList.innerHTML = '<div class="small">No alerts</div>'; return; }
          al.slice(0,50).forEach(a => {
            const div = document.createElement('div');
            div.className = 'alert-item';
            div.innerHTML = `<div style="font-weight:600">${a.type || 'alert'}</div><div class="small">${a.timestamp}</div><div style="margin-top:6px">${a.message}</div>`;
            alertsList.appendChild(div);
          });
        } catch (e) { alertsList.innerHTML = '<div class="small">Failed to load alerts</div>'; }
      }

      async function loadReports() {
        let reports = [];
        try { reports = await ipcRenderer.invoke('get-reports'); } catch (e) { console.error('get-reports failed', e); }
        return (reports || []).slice().reverse();
      }
      function renderReportItem(r){
        const card = document.createElement('div');
        card.className = 'card';

        const pct = r.record_total ? Math.round((r.record_sent / r.record_total) * 100) : 0;
        const statusLabel = r.status || 'unknown';

        card.innerHTML = `
          <div class="report-row">
            <div>
              <div class="title">${r.id}</div>
              <div class="meta">Template: ${r.template_name || '-'} ‚Ä¢ Profiles: ${Array.isArray(r.profiles)? r.profiles.join(', '): r.profiles}</div>
            </div>
            <div class="small">${statusLabel}</div>
          </div>
          <div style="margin-top:10px">
            <div class="progress"><i style="width:${pct}%"></i></div>
            <div style="display:flex;justify-content:space-between;margin-top:6px">
              <div class="small">Sent: ${r.record_sent}/${r.record_total} (${pct}%)</div>
              <div class="small">Failed: ${r.record_failed||0} ‚Ä¢ Not WhatsApp: ${r.record_not_whatsapp || 0}</div>
            </div>
          </div>
        `;

        const controls = document.createElement('div');
        controls.className = 'controls';

        const viewBtn = document.createElement('button'); viewBtn.textContent='ÔøΩ View Report';
        viewBtn.onclick = () => {
          openViewReportModal(r.id);
        };

        const pauseBtn = document.createElement('button'); pauseBtn.textContent = r.paused ? '‚ñ∂ Resume' : '‚è∏ Pause';
        pauseBtn.onclick = () => {
          if (r.paused) { 
            ipcRenderer.send('resume-job', r.id); 
            // Don't optimistically update UI - wait for backend response
          }
          else { 
            ipcRenderer.send('pause-job', r.id); 
            // Don't optimistically update UI - wait for backend response
          }
        };

        const cancelBtn = document.createElement('button'); cancelBtn.textContent='‚ùå Cancel';
        cancelBtn.onclick = ()=>{ if (confirm('Cancel this job?')) ipcRenderer.send('cancel-job', r.id); };

  // Show pause/resume and cancel buttons for active jobs (both running and paused)
        const statusLower = (r.status || '').toString().toLowerCase();
        const showControlsForActiveJobs = statusLower === 'in_progress' || 
                                         statusLower === 'in progress' || 
                                         statusLower === 'paused' || 
                                         statusLower === 'scheduled';

        // Don't show controls for completed or cancelled jobs
        const isFinishedJob = statusLower === 'completed' || 
                             statusLower === 'cancelled' || 
                             statusLower === 'failed';

        // Show "View Report" button for every job (opens modal with all records)
        controls.appendChild(viewBtn);
        
        // Show pause/resume and cancel buttons only for active jobs (not finished)
        if (showControlsForActiveJobs && !isFinishedJob) {
          controls.appendChild(pauseBtn);
          controls.appendChild(cancelBtn);
        }
        // If the job is finished and has failures, show "Resend Failed" button
        if (isFinishedJob && (r.record_failed || 0) > 0) {
          const resendBtn = document.createElement('button');
          resendBtn.textContent = 'üîÅ Resend Failed';
          resendBtn.onclick = () => openResendModal(r.id);
          controls.appendChild(resendBtn);
        }
        card.appendChild(controls);

        return card;
      }

      async function loadAll(){
        allReports = await loadReports();
        filterAndRenderReports();
      }

      function filterAndRenderReports() {
        const q = (searchInput.value || '').toLowerCase().trim();
        filteredReports = allReports.filter(r => {
          if (!q) return true;
          const hay = (r.id + ' ' + (r.template_name || '') + ' ' + (Array.isArray(r.profiles) ? r.profiles.join(' ') : r.profiles || '')).toLowerCase();
          return hay.includes(q);
        });
        
        renderReports();
      }

      function renderReports() {
        reportsContainer.innerHTML = '';
        
        if (filteredReports.length === 0) {
          reportsContainer.innerHTML = '<div class="card small">No reports found</div>';
          updatePaginationControls();
          return;
        }
        
        // Calculate pagination
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, filteredReports.length);
        const reportsToShow = filteredReports.slice(startIndex, endIndex);
        
        // Render reports for current page
        reportsToShow.forEach(r => reportsContainer.appendChild(renderReportItem(r)));
        
        // Update pagination controls
        updatePaginationControls();
      }

      ipcRenderer.on('alert-created', (e, a) => loadAlerts());
      ipcRenderer.on('job-paused', (e, id) => { loadAll(); });
      ipcRenderer.on('job-resumed', (e, id) => { loadAll(); });
      ipcRenderer.on('job-cancelled', (e, id) => { loadAll(); });
      
      // Handle resume failures for completed/inactive jobs
      ipcRenderer.on('job-resume-failed', (e, data) => {
        const { jobId, reason } = data;
        alert(`‚ùå Cannot resume job ${jobId}:\n\n${reason}\n\nThis job has likely completed or been cancelled. Please check the job status in the reports list.`);
        loadAll(); // Refresh to show current status
      });
      
      // Handle real-time reports updates from backend
      ipcRenderer.on('reports-updated', (e, updatedReports) => {
        if (updatedReports) {
          allReports = updatedReports;
          loadReports();
          setupAutoRefresh(); // Check if auto-refresh needed after update
        }
      });

      // Handle real-time progress updates for active jobs
      ipcRenderer.on('profile-message-progress', (e, progressData) => {
        updateJobProgress(progressData);
      });

      // Auto-refresh functionality for active jobs
      let autoRefreshInterval = null;
      const AUTO_REFRESH_DELAY = 6000; // 5 seconds

      function setupAutoRefresh() {
        // Clear existing interval
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }

        // Check if there are any active jobs
        const hasActiveJobs = allReports.some(report => {
          const status = (report.status || '').toString().toLowerCase();
          return status === 'in_progress' || status === 'in progress' || 
                 status === 'paused' || status === 'scheduled';
        });

        const indicator = document.getElementById('autoRefreshIndicator');
        
        if (hasActiveJobs) {
          console.log('üîÑ Starting auto-refresh for active jobs (every 5 seconds)');
          indicator.style.display = 'inline-block';
          autoRefreshInterval = setInterval(() => {
            console.log('üîÑ Auto-refreshing reports...');
            loadAll(); // Refresh the reports
          }, AUTO_REFRESH_DELAY);
        } else {
          console.log('‚úÖ No active jobs, auto-refresh stopped');
          indicator.style.display = 'none';
        }
      }

      // Stop auto-refresh when page is hidden/unfocused
      document.addEventListener('visibilitychange', () => {
        const indicator = document.getElementById('autoRefreshIndicator');
        
        if (document.hidden && autoRefreshInterval) {
          console.log('‚è∏Ô∏è Page hidden, pausing auto-refresh');
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          indicator.style.display = 'none';
        } else if (!document.hidden) {
          console.log('üëÅÔ∏è Page visible, checking auto-refresh');
          setupAutoRefresh();
        }
      });

      // Cleanup auto-refresh on page unload
      window.addEventListener('beforeunload', () => {
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
        }
      });

      function updateJobProgress(progressData) {
        const { id: jobId, sent, failed, total, status, profile, number, patient } = progressData;
        
        // Find the job in allReports and update it
        const jobIndex = allReports.findIndex(r => r.id === jobId);
        if (jobIndex !== -1) {
          allReports[jobIndex].record_sent = sent || 0;
          allReports[jobIndex].record_failed = failed || 0;
          
          // Update the specific job card without full reload
          updateJobCard(allReports[jobIndex]);
          
          console.log(`üìä Progress updated for ${jobId}: ${sent}/${total} sent, ${failed} failed`);
        }
      }

      function updateJobCard(report) {
        // Find the existing job card and update its progress info
        const existingCards = document.querySelectorAll('.report-card');
        existingCards.forEach(card => {
          const cardTitle = card.querySelector('strong');
          if (cardTitle && cardTitle.textContent.includes(report.id)) {
            // Update the progress info in the card
            const progressInfo = card.querySelector('.progress-info') || 
                                card.appendChild(document.createElement('div'));
            progressInfo.className = 'progress-info';
            progressInfo.innerHTML = `
              <div class="progress-bar" style="background: #e0e0e0; height: 4px; border-radius: 2px; margin: 5px 0;">
                <div style="background: #4CAF50; height: 100%; width: ${(report.record_sent / report.record_total * 100) || 0}%; border-radius: 2px;"></div>
              </div>
              <div class="small">Sent: ${report.record_sent || 0}/${report.record_total || 0} | Failed: ${report.record_failed || 0}</div>
            `;
          }
        });
      }

      // Resend modal helpers
      const resendModal = document.getElementById('resendModal');
      const resendList = document.getElementById('resendList');
      const resendJobIdEl = document.getElementById('resendJobId');
      const resendSendBtn = document.getElementById('resendSendBtn');
      const resendCancelBtn = document.getElementById('resendCancelBtn');
      const resendProgress = document.getElementById('resendProgress');

      // View Report modal helpers
      const viewReportModal = document.getElementById('viewReportModal');
      const viewReportList = document.getElementById('viewReportList');
      const viewReportJobIdEl = document.getElementById('viewReportJobId');
      const exportReportBtn = document.getElementById('exportReportBtn');
      const closeViewReportBtn = document.getElementById('closeViewReportBtn');
      const viewReportFilter = document.getElementById('viewReportFilter');

      let currentViewRows = [];

      function openViewReportModal(jobId) {
        viewReportJobIdEl.textContent = jobId;
        viewReportList.innerHTML = '<div class="small">Loading records...</div>';
        viewReportFilter.value = '';
        viewReportModal.style.display = 'flex';

        ipcRenderer.invoke('get-report-records', jobId).then(rows => {
          currentViewRows = rows || [];
          renderViewReportList(currentViewRows);
        }).catch(e => {
          viewReportList.innerHTML = '<div class="small">Failed to load records</div>';
        });
      }

      function closeViewReportModal() {
        viewReportModal.style.display = 'none';
        viewReportList.innerHTML = '';
        currentViewRows = [];
      }

      function renderViewReportList(rows) {
        if (!rows || rows.length === 0) {
          viewReportList.innerHTML = '<div class="small">No records for this report</div>';
          return;
        }
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        table.innerHTML = `
          <thead><tr style="background:#f7fafc"><th style="padding:8px;border-bottom:1px solid #eee">Name</th><th style="padding:8px;border-bottom:1px solid #eee">Phone</th><th style="padding:8px;border-bottom:1px solid #eee">Profile</th><th style="padding:8px;border-bottom:1px solid #eee">Status</th><th style="padding:8px;border-bottom:1px solid #eee">Sent At</th><th style="padding:8px;border-bottom:1px solid #eee">Error</th><th style="padding:8px;border-bottom:1px solid #eee">Message</th></tr></thead>
          <tbody></tbody>
        `;
        const tbody = table.querySelector('tbody');
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid #eee';
          tr.innerHTML = `
            <td style="padding:8px;vertical-align:top">${escapeHtml(r.name||'')}</td>
            <td style="padding:8px;vertical-align:top">${escapeHtml(r.phone||'')}</td>
            <td style="padding:8px;vertical-align:top">${escapeHtml(r.profile||'')}</td>
            <td style="padding:8px;vertical-align:top">${escapeHtml(r.status||'')}</td>
            <td style="padding:8px;vertical-align:top">${escapeHtml(r.sent_at||'')}</td>
            <td style="padding:8px;vertical-align:top;color:#a00">${escapeHtml(r.error||'')}</td>
            <td style="padding:8px;vertical-align:top">${escapeHtml((r.message||'').toString().substring(0,200))}</td>
          `;
          tbody.appendChild(tr);
        });
        viewReportList.innerHTML = '';
        viewReportList.appendChild(table);
      }

      // simple escape for HTML
      function escapeHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      closeViewReportBtn.addEventListener('click', () => closeViewReportModal());
      exportReportBtn.addEventListener('click', async () => {
        const jobId = viewReportJobIdEl.textContent;
        if (!jobId) return alert('No job id');
        exportReportBtn.disabled = true; exportReportBtn.textContent = 'Exporting...';
        try {
          const res = await ipcRenderer.invoke('export-report-records', { jobId });
          if (res && res.success) {
            alert('Exported to ' + res.path);
          } else {
            alert('Export failed: ' + (res && res.error ? res.error : 'unknown'));
          }
        } catch (e) { alert('Export failed: ' + e.message); }
        exportReportBtn.disabled = false; exportReportBtn.textContent = 'Export to Excel';
      });

      viewReportFilter.addEventListener('input', debounce(() => {
        const q = (viewReportFilter.value||'').toLowerCase().trim();
        if (!q) renderViewReportList(currentViewRows);
        else {
          const filtered = currentViewRows.filter(r => ((r.name||'') + ' ' + (r.phone||'') + ' ' + (r.status||'') + ' ' + (r.template||'') + ' ' + (r.error||'')).toLowerCase().includes(q));
          renderViewReportList(filtered);
        }
      }, 250));

      function openResendModal(jobId) {
        resendJobIdEl.textContent = jobId;
        resendList.innerHTML = '<div class="small">Loading failed messages...</div>';
        resendProgress.style.display = 'none';
        resendModal.style.display = 'flex';

        ipcRenderer.invoke('get-failed-message-logs', jobId).then(rows => {
          renderResendList(rows || []);
        }).catch(e => {
          resendList.innerHTML = '<div class="small">Failed to load failed messages</div>';
        });
      }

      function closeResendModal() {
        resendModal.style.display = 'none';
        resendList.innerHTML = '';
      }

      function renderResendList(rows) {
        if (!rows || rows.length === 0) {
          resendList.innerHTML = '<div class="small">No failed messages for this job</div>';
          return;
        }
        const frag = document.createDocumentFragment();
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';
        rows.forEach(r => {
          const tr = document.createElement('tr');
          tr.style.borderBottom = '1px solid #eee';
          const td0 = document.createElement('td'); td0.style.padding='8px'; td0.style.width='36px';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.id = r.id; cb.checked = true;
          td0.appendChild(cb);
          const td1 = document.createElement('td'); td1.style.padding='8px'; td1.innerHTML = `<div style="font-weight:600">${r.name || '-'}</div><div class="small">${r.phone || ''} ‚Ä¢ ${r.profile || ''}</div>`;
          const td2 = document.createElement('td'); td2.style.padding='8px'; td2.style.width='220px'; td2.innerHTML = `<div class="small">${(r.template||'-')}<div style="color:#a00">${r.error||''}</div></div>`;
          tr.appendChild(td0); tr.appendChild(td1); tr.appendChild(td2);
          // attach full row data for later resend
          tr.__row = r;
          frag.appendChild(tr);
        });
        resendList.innerHTML = '';
        resendList.appendChild(table);
        table.appendChild(frag);
      }

      resendCancelBtn.addEventListener('click', () => closeResendModal());

      resendSendBtn.addEventListener('click', () => {
        // Collect selected rows
        const checkboxes = resendList.querySelectorAll('input[type=checkbox]');
        const ids = [];
        const rows = [];
        checkboxes.forEach(cb => {
          if (cb.checked) ids.push(cb.dataset.id);
        });
        if (ids.length === 0) { alert('Select at least one failed message to resend'); return; }

        // Disable UI while resending
        resendSendBtn.disabled = true; resendCancelBtn.disabled = true;
        resendProgress.style.display = 'block'; resendProgress.textContent = `Preparing to resend ${ids.length} messages...`;

        // Request main process to resend by ids
        ipcRenderer.send('resend-failed-message-logs', { ids });

        ipcRenderer.on('resend-failed-progress', (e, data) => {
          resendProgress.textContent = `Resend progress: ${data.processed}/${data.total} ‚Äî Sent: ${data.sent} ‚Äî Failed: ${data.failed}`;
        });

        ipcRenderer.once('resend-failed-response', (e, res) => {
          resendSendBtn.disabled = false; resendCancelBtn.disabled = false;
          if (res && res.success) {
            resendProgress.textContent = `Done ‚Äî Processed: ${res.processed}, Sent: ${res.sent}, Failed: ${res.failed}`;
            // refresh reports after short delay
            setTimeout(() => { loadAll(); closeResendModal(); }, 800);
          } else {
            resendProgress.textContent = `Resend failed: ${res && res.message ? res.message : 'Unknown error'}`;
          }
        });
      });


      async function loadDailyStats() {
        try {
          const stats = await ipcRenderer.invoke('get-daily-stats', 7);
          const el = document.getElementById('dailyStats');
          el.innerHTML = '';
          // If all totals are zero (no records), show a friendly message
          const totalSum = (stats || []).reduce((acc, s) => acc + ((s && s.data && s.data.total) ? Number(s.data.total) : 0), 0);
          if (!stats || stats.length === 0 || totalSum === 0) {
            el.innerHTML = '<div class="small">No records</div>';
            return;
          }

          stats.forEach(s => {
            const div = document.createElement('div');
            div.style.marginBottom = '8px';
            const total = s.data ? s.data.total || 0 : 0;
            div.innerHTML = `<div style="display:flex;justify-content:space-between"><div><strong>${s.day}</strong></div><div class="small">Total: ${total}</div></div>`;
            // per-profile breakdown
            if (s.data && s.data.perProfile) {
              const bp = document.createElement('div'); bp.className='small'; bp.style.marginTop='6px';
              const items = Object.entries(s.data.perProfile).map(([p,c])=>`${p}: ${c}`);
              bp.textContent = items.join(' ‚Ä¢ ');
              div.appendChild(bp);
            }
            el.appendChild(div);
          });
        } catch (e) { console.error('get-daily-stats failed', e); }
      }

      (async function init(){
        await loadSettingsToUI();
        await loadAlerts();
        await loadAll();
        await loadDailyStats();
        setupAutoRefresh(); // Start auto-refresh if needed
      })();
    </script>
  </body>
</html>
